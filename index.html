<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Pokédex TCG v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .card-image { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card-image:hover { transform: scale(1.05); box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .loader { border-top-color: #facc15; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status-btn.active { transform: scale(1.1); filter: brightness(1.2); opacity: 1 !important; }
        .color-palette { display: none; position: absolute; bottom: -40px; left: 50%; transform: translateX(-50%); background-color: rgba(31, 41, 55, 0.9); padding: 5px; border-radius: 20px; z-index: 20; gap: 5px; }
        .card-container:hover .color-palette { display: flex; }
        .tab-btn.active { background-color: #facc15; color: #1f2937; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Tela de Carregamento Inicial -->
    <div id="initial-loader" class="loader-container">
        <div class="text-center">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-600 h-32 w-32 mx-auto"></div>
            <p class="mt-4 text-lg text-yellow-400">Carregando todas as cartas Pokémon...</p>
            <p id="loading-progress" class="text-gray-400 text-sm mt-2">Isso pode levar um momento.</p>
        </div>
    </div>

    <div id="app" class="container mx-auto p-4 max-w-7xl hidden">
        <!-- Cabeçalho -->
        <header class="text-center my-4 md:my-8">
            <h1 class="text-4xl md:text-5xl font-bold text-yellow-400" style="text-shadow: 2px 2px 4px #000;">Pokédex TCG</h1>
            <p class="text-gray-400 mt-2">Gerencie sua coleção com filtros e abas</p>
            <div id="auth-info" class="mt-4 text-xs text-gray-500"></div>
        </header>

        <!-- Filtros e Busca -->
        <div class="mb-6 sticky top-0 bg-gray-900/80 backdrop-blur-sm z-30 py-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="search-input" placeholder="Buscar por nome ou número..." class="md:col-span-3 bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-yellow-400">
                <select id="type-filter" class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-yellow-400">
                    <option value="">Todos os Tipos</option>
                </select>
                <select id="generation-filter" class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-yellow-400">
                    <option value="">Todas as Gerações</option>
                </select>
                 <select id="items-per-page" class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-yellow-400">
                    <option value="20">20 por página</option>
                    <option value="50">50 por página</option>
                    <option value="100">100 por página</option>
                    <option value="9999">Mostrar Todos</option>
                </select>
            </div>
        </div>

        <!-- Abas de Navegação -->
        <div class="mb-6">
            <div id="tabs-container" class="flex items-center justify-center space-x-2 md:space-x-4 bg-gray-800 p-2 rounded-lg">
                <button data-tab="all" class="tab-btn flex-1 text-center py-2 px-4 rounded-md transition-colors duration-300 active">Todos</button>
                <button data-tab="owned" class="tab-btn flex-1 text-center py-2 px-4 rounded-md transition-colors duration-300">Tenho</button>
                <button data-tab="favorite" class="tab-btn flex-1 text-center py-2 px-4 rounded-md transition-colors duration-300">Favoritas</button>
                <button data-tab="want" class="tab-btn flex-1 text-center py-2 px-4 rounded-md transition-colors duration-300">Desejo</button>
            </div>
        </div>
        
        <!-- Paginação -->
        <div id="pagination-controls" class="flex items-center justify-between my-4">
            <button id="prev-page" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">Anterior</button>
            <span id="page-info" class="text-gray-300">Página 1 de 1</span>
            <button id="next-page" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">Próxima</button>
        </div>

        <!-- Grade de Pokémon -->
        <div id="pokedex-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
            <!-- Cards serão inseridos aqui -->
        </div>
         <div id="no-results" class="text-center py-10 text-gray-400 hidden">
            <i class="fas fa-search text-4xl mb-4"></i>
            <p class="text-xl">Nenhum Pokémon encontrado</p>
            <p>Tente ajustar seus filtros ou o termo de busca.</p>
        </div>

        <!-- Modal para imagem ampliada -->
        <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 hidden">
            <img id="modal-img" src="" alt="Imagem ampliada da carta" class="max-w-full max-h-full rounded-lg">
            <button id="close-modal" class="absolute top-4 right-4 text-white text-3xl">&times;</button>
        </div>
    </div>

    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "...", projectId: "..." };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pokedex-tcg-app-default';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Elementos da UI
        const ui = {
            appContainer: document.getElementById('app'),
            initialLoader: document.getElementById('initial-loader'),
            loadingProgress: document.getElementById('loading-progress'),
            pokedexGrid: document.getElementById('pokedex-grid'),
            searchInput: document.getElementById('search-input'),
            typeFilter: document.getElementById('type-filter'),
            generationFilter: document.getElementById('generation-filter'),
            itemsPerPageSelect: document.getElementById('items-per-page'),
            tabsContainer: document.getElementById('tabs-container'),
            paginationControls: document.getElementById('pagination-controls'),
            prevPageBtn: document.getElementById('prev-page'),
            nextPageBtn: document.getElementById('next-page'),
            pageInfo: document.getElementById('page-info'),
            noResults: document.getElementById('no-results'),
            authInfo: document.getElementById('auth-info'),
            imageModal: document.getElementById('image-modal'),
            modalImg: document.getElementById('modal-img'),
            closeModal: document.getElementById('close-modal'),
        };

        // Estado da Aplicação
        const state = {
            allPokemonCards: [],
            filteredPokemon: [],
            userCardData: {},
            pokemonTypes: [],
            userId: null,
            isAuthReady: false,
            activeTab: 'all',
            currentPage: 1,
            itemsPerPage: 20,
            searchTerm: '',
            selectedType: '',
            selectedGeneration: '',
        };

        const COLORS = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6'];
        const GENERATIONS = {
            1: { name: 'Geração 1', range: [1, 151] },
            2: { name: 'Geração 2', range: [152, 251] },
            3: { name: 'Geração 3', range: [252, 386] },
            4: { name: 'Geração 4', range: [387, 493] },
            5: { name: 'Geração 5', range: [494, 649] },
            6: { name: 'Geração 6', range: [650, 721] },
            7: { name: 'Geração 7', range: [722, 809] },
            8: { name: 'Geração 8', range: [810, 905] },
            9: { name: 'Geração 9', range: [906, 1025] },
        };

        // --- INICIALIZAÇÃO ---
        async function init() {
            await authenticateUser();
            if (state.isAuthReady) {
                await loadUserCardData();
                setupRealtimeListener();
                await Promise.all([fetchAllPokemon(), fetchTypes()]);
                populateFilters();
                setupEventListeners();
                applyFiltersAndRender();
                ui.initialLoader.classList.add('hidden');
                ui.appContainer.classList.remove('hidden');
            }
        }

        // --- AUTENTICAÇÃO ---
        function authenticateUser() {
            return new Promise(resolve => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        state.userId = user.uid;
                        ui.authInfo.innerHTML = `<p>ID: <span class="font-mono bg-gray-700 px-1 rounded">${state.userId}</span></p>`;
                        state.isAuthReady = true;
                    } else {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Erro na autenticação:", error);
                            ui.authInfo.innerHTML = `<p class="text-red-500">Erro de conexão. A coleção não será salva.</p>`;
                        }
                    }
                    resolve();
                });
            });
        }

        // --- LÓGICA DO FIRESTORE ---
        async function loadUserCardData() {
            if (!state.userId) return;
            const q = query(collection(db, `artifacts/${appId}/users/${state.userId}/cards`));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach((doc) => {
                state.userCardData[doc.id] = doc.data();
            });
        }

        function setupRealtimeListener() {
            if (!state.userId) return;
            const q = query(collection(db, `artifacts/${appId}/users/${state.userId}/cards`));
            onSnapshot(q, (snapshot) => {
                let needsRender = false;
                snapshot.docChanges().forEach((change) => {
                    const cardId = change.doc.id;
                    state.userCardData[cardId] = change.doc.data();
                    const cardElement = document.getElementById(`card-${cardId}`);
                    if (cardElement) {
                        updateCardUI(cardElement, cardId);
                    }
                    if (state.activeTab !== 'all') {
                        needsRender = true;
                    }
                });
                if (needsRender) {
                    applyFiltersAndRender();
                }
            });
        }

        async function updateCardStatus(cardId, statusType, value) {
            if (!state.userId) return;
            const docRef = doc(db, `artifacts/${appId}/users/${state.userId}/cards/${cardId}`);
            const updateData = { [statusType]: value };
            if (statusType === 'markerColor' && !value) {
                updateData.markerColor = null;
            }
            try {
                await setDoc(docRef, updateData, { merge: true });
            } catch (error) {
                console.error("Erro ao salvar no Firestore:", error);
            }
        }

        // --- LÓGICA DA API POKÉMON TCG ---
        async function fetchAllPokemon() {
            let allCards = [];
            let uniquePokedexNumbers = new Set();
            let page = 1;
            let hasMore = true;
            const totalPokemonEstimate = 1025; 

            while(hasMore) {
                try {
                    const response = await fetch(`https://api.pokemontcg.io/v2/cards?q=supertype:pokemon&page=${page}&pageSize=250&orderBy=nationalPokedexNumbers`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    
                    if (data.data.length === 0) {
                        hasMore = false;
                    } else {
                        const newCards = data.data.filter(card => card.nationalPokedexNumbers && card.nationalPokedexNumbers.length > 0);
                        newCards.forEach(card => {
                            const pokedexNumber = card.nationalPokedexNumbers[0];
                            if (!uniquePokedexNumbers.has(pokedexNumber)) {
                                allCards.push(card);
                                uniquePokedexNumbers.add(pokedexNumber);
                            }
                        });
                        ui.loadingProgress.textContent = `Encontrados ${uniquePokedexNumbers.size} de ~${totalPokemonEstimate} Pokémon...`;
                        page++;
                        // Break if we seem to have most of them to avoid infinite loops on API changes
                        if (uniquePokedexNumbers.size >= totalPokemonEstimate) {
                            hasMore = false;
                        }
                    }
                } catch (error) {
                    console.error("Falha ao buscar Pokémon:", error);
                    hasMore = false;
                }
            }
            allCards.sort((a, b) => a.nationalPokedexNumbers[0] - b.nationalPokedexNumbers[0]);
            state.allPokemonCards = allCards;
        }

        async function fetchTypes() {
            try {
                const response = await fetch('https://api.pokemontcg.io/v2/types');
                const data = await response.json();
                state.pokemonTypes = data.data;
            } catch (error) {
                console.error("Falha ao buscar tipos:", error);
            }
        }
        
        // --- RENDERIZAÇÃO E FILTROS ---
        function populateFilters() {
            state.pokemonTypes.forEach(type => {
                const option = new Option(type, type);
                ui.typeFilter.add(option);
            });
            Object.entries(GENERATIONS).forEach(([num, gen]) => {
                const option = new Option(gen.name, num);
                ui.generationFilter.add(option);
            });
        }

        function applyFiltersAndRender() {
            let result = [...state.allPokemonCards];

            // 1. Filtro por Aba
            if (state.activeTab !== 'all') {
                result = result.filter(card => state.userCardData[card.id]?.[state.activeTab]);
            }

            // 2. Filtro por Geração
            if (state.selectedGeneration) {
                const gen = GENERATIONS[state.selectedGeneration];
                result = result.filter(card => {
                    const num = card.nationalPokedexNumbers[0];
                    return num >= gen.range[0] && num <= gen.range[1];
                });
            }

            // 3. Filtro por Tipo
            if (state.selectedType) {
                result = result.filter(card => card.types?.includes(state.selectedType));
            }

            // 4. Filtro por Busca
            if (state.searchTerm) {
                result = result.filter(card => {
                    const nameMatch = card.name.toLowerCase().includes(state.searchTerm);
                    const numberMatch = card.nationalPokedexNumbers[0].toString().includes(state.searchTerm);
                    return nameMatch || numberMatch;
                });
            }

            state.filteredPokemon = result;
            renderCurrentPage();
        }

        function renderCurrentPage() {
            ui.pokedexGrid.innerHTML = '';
            ui.noResults.classList.toggle('hidden', state.filteredPokemon.length > 0);
            ui.paginationControls.classList.toggle('hidden', state.filteredPokemon.length === 0);

            const totalPages = Math.ceil(state.filteredPokemon.length / state.itemsPerPage);
            state.currentPage = Math.max(1, Math.min(state.currentPage, totalPages));

            const start = (state.currentPage - 1) * state.itemsPerPage;
            const end = start + state.itemsPerPage;
            const pageItems = state.filteredPokemon.slice(start, end);

            pageItems.forEach(card => {
                const cardElement = createCardElement(card);
                ui.pokedexGrid.appendChild(cardElement);
            });
            
            updatePaginationUI(totalPages);
        }

        function updatePaginationUI(totalPages) {
            if (totalPages > 0) {
                 ui.pageInfo.textContent = `Página ${state.currentPage} de ${totalPages}`;
            } else {
                 ui.pageInfo.textContent = 'Nenhum resultado';
            }
            ui.prevPageBtn.disabled = state.currentPage === 1;
            ui.nextPageBtn.disabled = state.currentPage === totalPages || totalPages === 0;
        }

        function createCardElement(card) {
            const pokedexNumber = card.nationalPokedexNumbers[0];
            const element = document.createElement('div');
            element.id = `card-${card.id}`;
            element.className = 'card-container relative bg-gray-800 rounded-lg overflow-hidden shadow-lg border-4 border-transparent transition-all duration-300';
            
            element.innerHTML = `
                <img src="${card.images.small}" alt="${card.name}" class="card-image w-full h-auto cursor-pointer" loading="lazy">
                <div class="p-2 text-center">
                    <p class="font-bold text-sm truncate">${card.name}</p>
                    <p class="text-xs text-gray-400">#${pokedexNumber}</p>
                </div>
                <div class="absolute top-1 right-1 flex flex-col gap-1.5 z-10">
                    <button data-status="owned" style="opacity:0.5" class="status-btn bg-green-500/80 hover:bg-green-500 text-white w-7 h-7 rounded-full text-xs shadow-md transition-transform"><i class="fas fa-check"></i></button>
                    <button data-status="favorite" style="opacity:0.5" class="status-btn bg-red-500/80 hover:bg-red-500 text-white w-7 h-7 rounded-full text-xs shadow-md transition-transform"><i class="fas fa-heart"></i></button>
                    <button data-status="want" style="opacity:0.5" class="status-btn bg-blue-500/80 hover:bg-blue-500 text-white w-7 h-7 rounded-full text-xs shadow-md transition-transform"><i class="fas fa-star"></i></button>
                </div>
                <div class="color-palette">
                    ${COLORS.map(color => `<div class="color-swatch w-6 h-6 rounded-full cursor-pointer" style="background-color: ${color};" data-color="${color}"></div>`).join('')}
                </div>
            `;

            element.querySelector('.card-image').addEventListener('click', () => openImageModal(card.images.large));
            element.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const status = btn.dataset.status;
                    const isActive = !(state.userCardData[card.id]?.[status]);
                    updateCardStatus(card.id, status, isActive);
                });
            });
            element.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const newColor = swatch.dataset.color;
                    const currentColor = state.userCardData[card.id]?.markerColor;
                    updateCardStatus(card.id, 'markerColor', currentColor === newColor ? null : newColor);
                });
            });

            updateCardUI(element, card.id);
            return element;
        }

        function updateCardUI(cardElement, cardId) {
            const data = state.userCardData[cardId] || {};
            cardElement.querySelector('[data-status="owned"]').classList.toggle('active', !!data.owned);
            cardElement.querySelector('[data-status="favorite"]').classList.toggle('active', !!data.favorite);
            cardElement.querySelector('[data-status="want"]').classList.toggle('active', !!data.want);
            cardElement.style.borderColor = data.markerColor || 'transparent';
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            ui.searchInput.addEventListener('input', (e) => {
                state.searchTerm = e.target.value.toLowerCase().trim();
                state.currentPage = 1;
                applyFiltersAndRender();
            });
            ui.typeFilter.addEventListener('change', (e) => {
                state.selectedType = e.target.value;
                state.currentPage = 1;
                applyFiltersAndRender();
            });
            ui.generationFilter.addEventListener('change', (e) => {
                state.selectedGeneration = e.target.value;
                state.currentPage = 1;
                applyFiltersAndRender();
            });
            ui.itemsPerPageSelect.addEventListener('change', (e) => {
                state.itemsPerPage = parseInt(e.target.value, 10);
                state.currentPage = 1;
                applyFiltersAndRender();
            });
            ui.tabsContainer.addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    ui.tabsContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    state.activeTab = e.target.dataset.tab;
                    state.currentPage = 1;
                    applyFiltersAndRender();
                }
            });
            ui.prevPageBtn.addEventListener('click', () => {
                if (state.currentPage > 1) {
                    state.currentPage--;
                    renderCurrentPage();
                }
            });
            ui.nextPageBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(state.filteredPokemon.length / state.itemsPerPage);
                if (state.currentPage < totalPages) {
                    state.currentPage++;
                    renderCurrentPage();
                }
            });
            ui.closeModal.addEventListener('click', () => ui.imageModal.classList.add('hidden'));
            ui.imageModal.addEventListener('click', (e) => {
                if (e.target === ui.imageModal) ui.imageModal.classList.add('hidden');
            });
        }
        
        function openImageModal(src) {
            ui.modalImg.src = src;
            ui.imageModal.classList.remove('hidden');
        }

        // Iniciar a aplicação
        init();
    </script>
</body>
</html>

